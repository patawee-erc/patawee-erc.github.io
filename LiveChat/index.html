<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>>Tee Rabai LiveChat</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4096/4096358.png">
  <style>

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #ece5dd; }


    #messages { 
      list-style-type: none; 
      margin: 0; 
      padding: 15px; 
      padding-bottom: 90px; 
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      height: 100vh;
      box-sizing: border-box;
    }

    .message-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
      max-width: 80%;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .sender-name { font-size: 0.7rem; color: #777; margin-bottom: 2px; margin-left: 5px; }

   
    .bubble {
      padding: 8px 12px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.5;
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
      word-wrap: break-word;
      position: relative;
    }


    .msg-time {
      font-size: 0.6rem;
      text-align: right;
      opacity: 0.6;
      margin-top: 4px;
      line-height: 1;
    }


    .chat-image {
      max-width: 100%;
      border-radius: 8px;
      display: block;
      margin-bottom: 4px;
    }


    .bubble.only-emoji {
      background: none !important;
      box-shadow: none !important;
      font-size: 4em;
      padding: 0;
      line-height: 1.1;
    }
    .bubble.only-emoji .msg-time {
       text-shadow: 0 0 2px #fff; 
       font-size: 0.2em; 
       color: #555;
    }


    .message-left { align-self: flex-start; }
    .message-left .bubble { background: #fff; color: #000; border-bottom-left-radius: 2px; }


    .message-right { align-self: flex-end; align-items: flex-end; }
    .message-right .sender-name { display: none; } 
    .message-right .bubble { background: #dcf8c6; color: #000; border-bottom-right-radius: 2px; }


    #footer-area {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 100;
    }

   
    #typing-indicator {
      background: rgba(255, 255, 255, 0.9);
      color: #128C7E;
      font-size: 0.75rem;
      padding: 4px 15px;
      font-style: italic;
      display: none;
      border-top: 1px solid #eee;
    }


    #form-container { 
      background: #f0f0f0; padding: 8px; display: flex; align-items: center;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
    }

    input { 
      flex: 1; padding: 12px 10px; border: none; border-radius: 25px; 
      outline: none; font-size: 1.1rem; background: #fff;
    }

    button { border: none; background: none; cursor: pointer; }
    
    #emoji-btn { font-size: 1.8rem; padding: 0 10px; transition: transform 0.1s; }
    #emoji-btn:active { transform: scale(0.9); }

    #send-btn { 
      margin-left: 12px; background: #128C7E; color: white; 
      border-radius: 50%; width: 48px; height: 48px; 
      font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
    }


    #emoji-picker {
      position: fixed; bottom: 80px; left: 10px; right: 10px;
      max-width: 100%;
      background: white; border-radius: 15px; padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none;
      flex-wrap: wrap; gap: 8px; z-index: 200;
      justify-content: center;
      max-height: 40vh; overflow-y: auto;
    }
    
    .emoji-item { font-size: 2.5rem; padding: 5px; cursor: pointer; user-select: none; }
    .emoji-item:hover { background-color: #f2f2f2; border-radius: 10px; transform: scale(1.1); transition: 0.2s;}


.system-message-row {
  display: flex;
  justify-content: center;
  margin: 10px 0;
  width: 100%;
}

.system-bubble {
  background-color: #fff3cd; 
  color: #856404;
  padding: 10px 15px;
  border-radius: 10px;
  border: 1px solid #ffeeba;
  font-size: 0.85rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  text-align: left;
  line-height: 1.6;
}

.system-bubble b { color: #533f03; }

  </style>
</head>
<body>


  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a" preload="auto"></audio>


  <div id="messages"></div>


  <div id="emoji-picker"></div>


  <div id="footer-area">

    <div id="typing-indicator"></div>

    <form id="form-container">
      <button type="button" id="emoji-btn">üòä</button>
      <input id="input" autocomplete="off" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
      <button type="submit" id="send-btn">‚û§</button>
    </form>
  </div>


  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    
    var firebaseConfig = {
      apiKey: "AIzaSyCnX049F08ewwCLXOCa3NrKsG499Qce6bI",
      authDomain: "livechat-75751.firebaseapp.com",
      databaseURL: "https://livechat-75751-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "livechat-75751",
      storageBucket: "livechat-75751.firebasestorage.app",
      messagingSenderId: "314131503440",
      appId: "1:314131503440:web:53d6918b7645630bf5f455",
      measurementId: "G-MVP0BBDFQV"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    var database = firebase.database();


    const animals = ["‡∏´‡∏°‡∏π", "‡πÅ‡∏°‡∏ß", "‡πÄ‡∏™‡∏∑‡∏≠", "‡πÑ‡∏Å‡πà", "‡πÄ‡∏õ‡πá‡∏î", "‡∏´‡∏°‡∏µ", "‡∏ï‡∏∏‡πà‡∏ô", "‡∏ä‡πâ‡∏≤‡∏á", "‡∏•‡∏¥‡∏á", "‡∏´‡∏°‡∏≤", "‡πÅ‡∏û‡∏ô‡∏î‡πâ‡∏≤"];
    const adjs = ["‡∏ã‡πà‡∏≤", "‡∏ï‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÇ‡∏ö", "‡∏†‡∏π‡πÄ‡∏Ç‡∏≤", "‡∏ö‡∏¥‡∏ô‡πÑ‡∏î‡πâ", "‡∏á‡πà‡∏ß‡∏á", "‡∏´‡∏¥‡∏ß", "‡∏à‡∏≠‡∏°‡∏ã‡∏ô", "‡∏≠‡∏¥‡∏ô‡∏î‡∏µ‡πâ", "‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å", "‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô"];
    const badWords = [ "‡πÄ‡∏´‡∏µ‡πâ‡∏¢", "‡∏™‡∏±‡∏™", "‡∏Ñ‡∏ß‡∏¢", "‡πÄ‡∏¢‡πá‡∏î", "‡∏´‡∏µ", "‡πÅ‡∏ï‡∏î", "hee", "kuy"];

    let myId = localStorage.getItem('chat_id');
    let myName = localStorage.getItem('chat_name');

    if (!myId) {
      myId = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
      myName = animals[Math.floor(Math.random() * animals.length)] + adjs[Math.floor(Math.random() * adjs.length)];
      localStorage.setItem('chat_id', myId);
      localStorage.setItem('chat_name', myName);
    }

    function censorText(text) {
      let cleanText = text;
      badWords.forEach(word => {
        let regex = new RegExp(word, "gi");
        cleanText = cleanText.replace(regex, "*".repeat(word.length));
      });
      return cleanText;
    }

    function isEmojiOnly(str) {
       const check = str.replace(/\s/g, '');
       if (check.length === 0) return false;
       const hasText = /[a-zA-Z0-9‡∏Å-‡πô]/.test(check);
       return !hasText;
    }


    function isImageUrl(url) {
      return (url.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i) != null);
    }

    const inputField = document.getElementById('input');
    const messagesDiv = document.getElementById('messages');
    const emojiPicker = document.getElementById('emoji-picker');
    const typingDiv = document.getElementById('typing-indicator');

    inputField.placeholder = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "${myName}" ...`;


    const emojis = ["üòÄ","üòÇ","üòç","üòé","üò≠","üò°","üëç","üëé","üôè","‚ù§Ô∏è","üíî","üéâ","üî•","‚ú®","üëª","üê∑","üê∂","üê±","üêî","üåπ","‚òÄÔ∏è","‚úÖ","‚ùå","‚ùì"];
    const emojiBtn = document.getElementById('emoji-btn');
    
    emojis.forEach(char => {
      let span = document.createElement('span');
      span.textContent = char;
      span.className = 'emoji-item';
      span.onclick = () => {
        inputField.value += char;
        inputField.focus();
        triggerTyping();
      };
      emojiPicker.appendChild(span);
    });

    emojiBtn.onclick = (e) => {
      e.stopPropagation();
      emojiPicker.style.display = (emojiPicker.style.display === 'flex') ? 'none' : 'flex';
    };
    document.body.onclick = (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) emojiPicker.style.display = 'none';
    };


    document.getElementById('form-container').addEventListener('submit', function(e) {
      e.preventDefault();
      var msg = inputField.value.trim();

      if (msg) {

        if (msg === '/help' || msg === '/‡πÄ‡∏°‡∏ô‡∏π') {
        const helpHtml = `
          <div style="text-align:center; font-weight:bold; margin-bottom:5px;">ü§ñ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
           <b>/‡∏ä‡∏∑‡πà‡∏≠</b> ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠<br>
           <b>/‡∏•‡∏ö‡∏´‡∏°‡∏î</b> -> ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br>
           <b> url link ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° .jpg</b> -> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û<br>
           <b>/help</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>/‡πÄ‡∏°‡∏ô‡∏π</b> -> ‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        `;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Bubble ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Database)
        var sysRow = document.createElement('div');
        sysRow.className = 'system-message-row';
        sysRow.innerHTML = `<div class="system-bubble">${helpHtml}</div>`;
        messagesDiv.appendChild(sysRow);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        inputField.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
      }

        if (msg.startsWith('/‡∏ä‡∏∑‡πà‡∏≠ ')) {
          var newName = msg.replace('/‡∏ä‡∏∑‡πà‡∏≠ ', '').trim().substring(0, 20);
          if (newName) {
            myName = newName;
            localStorage.setItem('chat_name', myName);
            inputField.placeholder = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "${myName}" ...`;
            alert('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô: ' + myName);
            

            database.ref('typing/' + myId).remove();
          }
          inputField.value = '';
          return; 
        }

        if (msg === '/‡∏•‡∏ö‡∏´‡∏°‡∏î') {
          if (confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) database.ref('chats').remove();
          inputField.value = '';
          return;
        }

        msg = censorText(msg);

        database.ref('chats').push({
          message: msg,
          senderName: myName,
          senderId: myId,
          time: Date.now()
        });

        database.ref('typing/' + myId).remove();

        inputField.value = '';
        emojiPicker.style.display = 'none';
      }
    });


    database.ref('chats').on('child_added', function(snapshot) {
      createMessageBubble(snapshot.val());

      if (snapshot.val().senderId !== myId) {
        var audio = document.getElementById('notif-sound');
        audio.volume = 0.5;
        audio.play().catch(e => {}); 
      }
    });

    database.ref('chats').on('value', function(snapshot) {
      if (!snapshot.exists()) messagesDiv.innerHTML = '';
    });

    function createMessageBubble(data) {
      var row = document.createElement('div');
      row.className = 'message-row';

      var nameSpan = document.createElement('div');
      nameSpan.className = 'sender-name';
      nameSpan.textContent = data.senderName;

      var bubble = document.createElement('div');
      bubble.className = 'bubble';


      var dateObj = new Date(data.time);
      var timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });


      let contentHtml = '';
      if (isImageUrl(data.message)) {

        contentHtml = `<img src="${data.message}" class="chat-image" onclick="window.open(this.src)">`;
      } else {

        contentHtml = `<span>${data.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>`;
        
        if (isEmojiOnly(data.message)) {
          bubble.classList.add('only-emoji');
        }
      }

      bubble.innerHTML = `${contentHtml}<div class="msg-time">${timeStr}</div>`;

      if (data.senderId === myId) {
        row.classList.add('message-right');
      } else {
        row.classList.add('message-left');
      }

      row.appendChild(nameSpan);
      row.appendChild(bubble);
      messagesDiv.appendChild(row);
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }


    let typingTimer;
    
    function triggerTyping() {

      database.ref('typing/' + myId).set({
        name: myName,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });


      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        database.ref('typing/' + myId).remove();
      }, 2000);
    }

    inputField.addEventListener('input', () => {
      triggerTyping();
    });


    database.ref('typing/' + myId).onDisconnect().remove();

    database.ref('typing').on('value', function(snapshot) {
      const typers = [];
      snapshot.forEach(child => {

        if (child.key !== myId) {
          typers.push(child.val().name);
        }
      });

      if (typers.length > 0) {

        let text = typers.length > 2 ? "‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå..." : typers.join(", ") + " ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...";
        typingDiv.textContent = text;
        typingDiv.style.display = 'block';
      } else {
        typingDiv.style.display = 'none';
      }
      
 
    });

  </script>
</body>
</html>
