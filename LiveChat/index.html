<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>Tee Rabai LiveChat</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/4096/4096358.png">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ---------------- UI ‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î‡πÉ‡∏´‡∏°‡πà ---------------- */
    body { 
      font-family: 'Prompt', -apple-system, BlinkMacSystemFont, sans-serif; 
      margin: 0; 
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      
      /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç --- */
      height: 100vh; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤ */
      height: 100dvh; /* ‡πÉ‡∏ä‡πâ dvh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏Å‡∏•‡∏ö Navigation Bar / Safari Toolbar ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
      height: calc(var(--vh, 1vh) * 100); /* ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JS */
      /* ----------------- */

      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header ‡∏ö‡∏≤‡∏£‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
    #header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 100;
    }
    #header h2 { margin: 0; font-size: 1.2rem; color: #128C7E; font-weight: 600; }
    #user-badge { background: #128C7E; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }

    #messages { 
      list-style-type: none; margin: 0; padding: 20px 15px; padding-bottom: 20px; 
      display: flex; flex-direction: column; overflow-y: auto; flex: 1; 
      scroll-behavior: smooth;
    }
    
    /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ) */
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }

    .message-row { 
      display: flex; flex-direction: column; margin-bottom: 12px; max-width: 80%; position: relative; 
    }
    
    /* --- Animations --- */
    @keyframes slideInLeft { 
      from { opacity: 0; transform: translateX(-30px) scale(0.95); } 
      to { opacity: 1; transform: translateX(0) scale(1); } 
    }
    @keyframes slideInRight { 
      from { opacity: 0; transform: translateX(30px) scale(0.95); } 
      to { opacity: 1; transform: translateX(0) scale(1); } 
    }
    @keyframes slideUpFade {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sender-name { font-size: 0.75rem; color: #555; margin-bottom: 4px; margin-left: 5px; font-weight: 500; }
    
    .bubble { 
      padding: 10px 14px; 
      border-radius: 18px; 
      font-size: 0.95rem; 
      line-height: 1.5; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.08); 
      word-wrap: break-word; 
      position: relative; 
      display: inline-block;
    }
    .msg-time { font-size: 0.65rem; text-align: right; opacity: 0.6; margin-top: 5px; line-height: 1; }
    .chat-image { max-width: 100%; border-radius: 12px; display: block; margin-bottom: 4px; cursor: pointer; transition: transform 0.2s; }
    .chat-image:hover { transform: scale(1.02); }
    
    .bubble.only-emoji { background: none !important; box-shadow: none !important; font-size: 4.5em; padding: 0; line-height: 1.1; }
    .bubble.only-emoji .msg-time { text-shadow: 0 0 3px rgba(255,255,255,0.8); font-size: 0.15em; color: #444; }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ä‡∏ó‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏ã‡πâ‡∏≤‡∏¢) */
    .message-left { align-self: flex-start; animation: slideInLeft 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
    .message-left .bubble { background: #ffffff; color: #333; border-bottom-left-radius: 4px; }
    
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ä‡∏ó‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á (‡∏Ç‡∏ß‡∏≤) */
    .message-right { align-self: flex-end; align-items: flex-end; animation: slideInRight 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
    .message-right .sender-name { display: none; } 
    .message-right .bubble { background: linear-gradient(135deg, #dcf8c6 0%, #c4f0a2 100%); color: #000; border-bottom-right-radius: 4px; }
    
    .date-divider { display: flex; justify-content: center; margin: 25px 0 15px 0; width: 100%; }
    .date-badge { background-color: rgba(0, 0, 0, 0.2); color: #fff; padding: 5px 15px; border-radius: 15px; font-size: 0.75rem; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); letter-spacing: 0.5px;}
    
    .system-message-row { display: flex; justify-content: center; margin: 15px 0; width: 100%; animation: slideUpFade 0.4s ease forwards;}
    .system-bubble { background-color: #fff3cd; color: #856404; padding: 8px 18px; border-radius: 20px; border: 1px solid #ffeeba; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
    .system-bubble b { color: #533f03; }
    
    /* Footer & Input Area */
    #footer-area { position: relative; z-index: 100; padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px); border-top: 1px solid rgba(0,0,0,0.05); box-shadow: 0 -5px 15px rgba(0,0,0,0.03); }
    
    /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏à‡∏∏‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (Typing Dots) */
    #typing-indicator { display: none; color: #128C7E; font-size: 0.8rem; padding: 0 15px 8px; font-weight: 500; align-items: center; gap: 5px; }
    .typing-dots { display: inline-flex; gap: 3px; align-items: center; margin-left: 5px; }
    .dot { width: 5px; height: 5px; background-color: #128C7E; border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out both; }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1.2); opacity: 1; } }

    #form-container { display: flex; align-items: center; background: #fff; padding: 5px 10px; border-radius: 30px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
    input { flex: 1; padding: 12px 10px; border: none; background: transparent; outline: none; font-size: 1.05rem; font-family: 'Prompt', sans-serif;}
    input::placeholder { color: #aaa; }
    button { border: none; background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    #emoji-btn { font-size: 1.6rem; padding: 0 5px; transition: transform 0.2s; color: #888; }
    #emoji-btn:hover { transform: scale(1.1); }
    #emoji-btn:active { transform: scale(0.9); }
    
    #send-btn { 
      margin-left: 8px; 
      background: linear-gradient(135deg, #128C7E, #075E54); 
      color: white; 
      border-radius: 50%; 
      width: 44px; 
      height: 44px; 
      box-shadow: 0 3px 6px rgba(18, 140, 126, 0.4); 
      transition: all 0.2s; 
    }
    #send-btn svg { width: 20px; height: 20px; fill: white; transform: translateX(2px); }
    #send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(18, 140, 126, 0.5); }
    #send-btn:active { transform: scale(0.95); }
    
    #emoji-picker { 
      position: absolute; bottom: calc(100% + 15px); left: 15px; right: 15px; 
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); 
      border-radius: 18px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
      display: none; flex-wrap: wrap; gap: 10px; z-index: 200; justify-content: center; 
      max-height: 40vh; overflow-y: auto;
      animation: slideUpFade 0.2s ease-out forwards;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .emoji-item { font-size: 2.2rem; padding: 5px; cursor: pointer; user-select: none; transition: transform 0.2s; }
    .emoji-item:hover { background-color: rgba(0,0,0,0.05); border-radius: 12px; transform: scale(1.2); }
  </style>
</head>
<body>

  <!-- ‡πÅ‡∏ñ‡∏ö Header ‡πÉ‡∏´‡∏°‡πà -->
  <div id="header">
    <h2>Tee Rabai LiveChat</h2>
    <span id="user-badge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
  </div>

  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a" preload="auto"></audio>
  <div id="messages"></div>

  <div id="footer-area">
    <div id="emoji-picker"></div>
    <!-- ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà -->
    <div id="typing-indicator">
      <span id="typing-text"></span>
      <div class="typing-dots">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>
    
    <form id="form-container">
      <button type="button" id="emoji-btn">üòä</button>
      <input id="input" autocomplete="off" placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠..." disabled />
      <button type="submit" id="send-btn">
        <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô SVG ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© -->
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
      </button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
   
    function setDocHeight() {
     
      document.documentElement.style.setProperty('--vh', `${window.innerHeight/100}px`);
    }
    
    window.addEventListener('resize', setDocHeight);
    window.addEventListener('orientationchange', setDocHeight);
    setDocHeight();
    
    
    var firebaseConfig = {
      apiKey: "AIzaSyCnX049F08ewwCLXOCa3NrKsG499Qce6bI",
      authDomain: "livechat-75751.firebaseapp.com",
      databaseURL: "https://livechat-75751-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "livechat-75751",
      storageBucket: "livechat-75751.firebasestorage.app",
      messagingSenderId: "314131503440",
      appId: "1:314131503440:web:53d6918b7645630bf5f455",
      measurementId: "G-MVP0BBDFQV"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    var database = firebase.database();
    var auth = firebase.auth(); 

    const animals = ["‡∏´‡∏°‡∏π", "‡πÅ‡∏°‡∏ß", "‡πÄ‡∏™‡∏∑‡∏≠", "‡πÑ‡∏Å‡πà", "‡πÄ‡∏õ‡πá‡∏î", "‡∏´‡∏°‡∏µ", "‡∏ï‡∏∏‡πà‡∏ô", "‡∏ä‡πâ‡∏≤‡∏á", "‡∏•‡∏¥‡∏á", "‡∏´‡∏°‡∏≤", "‡πÅ‡∏û‡∏ô‡∏î‡πâ‡∏≤"];
    const adjs = ["‡∏ã‡πà‡∏≤", "‡∏ï‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÇ‡∏ö", "‡∏†‡∏π‡πÄ‡∏Ç‡∏≤", "‡∏ö‡∏¥‡∏ô‡πÑ‡∏î‡πâ", "‡∏á‡πà‡∏ß‡∏á", "‡∏´‡∏¥‡∏ß", "‡∏à‡∏≠‡∏°‡∏ã‡∏ô", "‡∏≠‡∏¥‡∏ô‡∏î‡∏µ‡πâ", "‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å", "‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô"];
    const badWords = [ "‡πÄ‡∏´‡∏µ‡πâ‡∏¢", "‡∏™‡∏±‡∏™", "‡∏Ñ‡∏ß‡∏¢", "‡πÄ‡∏¢‡πá‡∏î", "‡∏´‡∏µ", "‡πÅ‡∏ï‡∏î", "hee", "kuy"];

    let lastDateDisplayed = null;
    let myId = null; 
    let myName = localStorage.getItem('chat_name');
    
    const userBadge = document.getElementById('user-badge'); // Element ‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô Header

    auth.onAuthStateChanged((user) => {
      if (user) {
        myId = user.uid;
        if (!myName) {
            myName = animals[Math.floor(Math.random() * animals.length)] + adjs[Math.floor(Math.random() * adjs.length)];
            localStorage.setItem('chat_name', myName);
        }
        inputField.disabled = false;
        inputField.placeholder = `‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...`;
        userBadge.textContent = myName; // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô Header
      } else {
        auth.signInAnonymously().catch((error) => console.error(error));
      }
    });

    function censorText(text) {
      let cleanText = text;
      badWords.forEach(word => {
        let regex = new RegExp(word, "gi");
        cleanText = cleanText.replace(regex, "*".repeat(word.length));
      });
      return cleanText;
    }
    function isEmojiOnly(str) {
       const check = str.replace(/\s/g, '');
       if (check.length === 0) return false;
       return !/[a-zA-Z0-9‡∏Å-‡πô]/.test(check);
    }
    function isImageUrl(url) {
      return (url.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i) != null);
    }
    function getNiceDate(timestamp) {
      const date = new Date(timestamp);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const dStr = date.toDateString();
      const tStr = today.toDateString();
      const yStr = yesterday.toDateString();
      if (dStr === tStr) return "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
      if (dStr === yStr) return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô";
      return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
    }
    function createDateDivider(timestamp) {
      const div = document.createElement('div');
      div.className = 'date-divider';
      div.innerHTML = `<span class="date-badge">${getNiceDate(timestamp)}</span>`;
      document.getElementById('messages').appendChild(div);
    }
    function createSystemMessage(htmlContent, bgColor = '#fff3cd', color='#856404') {
        var sysRow = document.createElement('div');
        sysRow.className = 'system-message-row';
        sysRow.innerHTML = `<div class="system-bubble" style="background:${bgColor}; color:${color}; border-color:${bgColor};">${htmlContent}</div>`;
        messagesDiv.appendChild(sysRow);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    const inputField = document.getElementById('input');
    const messagesDiv = document.getElementById('messages');
    const emojiPicker = document.getElementById('emoji-picker');
    const typingDiv = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');

    const emojis = ["üòÄ","üòÇ","üòç","üòé","üò≠","üò°","üëç","üëé","üôè","‚ù§Ô∏è","üíî","üéâ","üî•","‚ú®","üëª","üê∑","üê∂","üê±","üêî","üåπ","‚òÄÔ∏è","‚úÖ","‚ùå","‚ùì"];
    const emojiBtn = document.getElementById('emoji-btn');
    emojis.forEach(char => {
      let span = document.createElement('span');
      span.textContent = char;
      span.className = 'emoji-item';
      span.onclick = () => { inputField.value += char; inputField.focus(); triggerTyping(); };
      emojiPicker.appendChild(span);
    });

    emojiBtn.onclick = (e) => { e.stopPropagation(); emojiPicker.style.display = (emojiPicker.style.display === 'flex') ? 'none' : 'flex'; };
    document.body.onclick = (e) => { if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) emojiPicker.style.display = 'none'; };

    document.getElementById('form-container').addEventListener('submit', function(e) {
      e.preventDefault();
      var msg = inputField.value.trim();

      if (msg && myId) {
        if (msg === '/help' || msg === '/‡πÄ‡∏°‡∏ô‡∏π') {
            const helpHtml = `
              <div style="text-align:center; font-weight:bold; margin-bottom:5px;">ü§ñ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</div>
              ‚Ä¢ <b>/‡∏ä‡∏∑‡πà‡∏≠</b> [‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà] -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠<br>
              ‚Ä¢ <b>/‡∏•‡∏ö‡∏´‡∏°‡∏î</b> -> ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó (‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™)<br>
            `;
            createSystemMessage(helpHtml);
            inputField.value = '';
            return;
        }

        if (msg === '/‡∏•‡∏ö‡∏´‡∏°‡∏î') {
            let password = prompt("üîê ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö (Admin):");
            if (!password) { inputField.value = ''; return; }

            createSystemMessage("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...", '#e2e3e5', '#383d41');
            
            database.ref('admins/' + myId).set(password)
            .then(() => {
                return database.ref('chats').remove();
            })
            .then(() => {
                createSystemMessage("‚úÖ ‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ä‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", '#d4edda', '#155724');
                database.ref('admins/' + myId).remove();
            })
            .catch((error) => {
                console.error(error);
                createSystemMessage("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î! ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö", '#f8d7da', '#721c24');
            });

            inputField.value = '';
            return;
        }

        if (msg.startsWith('/‡∏ä‡∏∑‡πà‡∏≠ ')) {
          var newName = msg.replace('/‡∏ä‡∏∑‡πà‡∏≠ ', '').trim().substring(0, 20);
          if (newName) {
            myName = newName;
            localStorage.setItem('chat_name', myName);
            userBadge.textContent = myName; // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏µ‡πà Header ‡∏î‡πâ‡∏ß‡∏¢
            createSystemMessage(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô: <b>${myName}</b> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, '#d4edda', '#155724');
            database.ref('typing/' + myId).remove();
          }
          inputField.value = '';
          return; 
        }

        msg = censorText(msg);
        database.ref('chats').push({
          message: msg, 
          senderName: myName, 
          senderId: myId, 
          time: firebase.database.ServerValue.TIMESTAMP 
        });

        database.ref('typing/' + myId).remove();
        inputField.value = '';
        emojiPicker.style.display = 'none';
      }
    });

    database.ref('chats').on('child_added', function(snapshot) {
      var data = snapshot.val();
      const msgDate = new Date(data.time).toDateString();
      if (lastDateDisplayed !== msgDate) {
        createDateDivider(data.time);
        lastDateDisplayed = msgDate;
      }
      createMessageBubble(data);
      if (data.senderId !== myId) {
        var audio = document.getElementById('notif-sound');
        audio.volume = 0.5;
        audio.play().catch(e => {}); 
      }
    });

    database.ref('chats').on('value', function(snapshot) {
      if (!snapshot.exists()) {
        messagesDiv.innerHTML = '';
        lastDateDisplayed = null; 
      }
    });

    function createMessageBubble(data) {
      var row = document.createElement('div');
      row.className = 'message-row';
      var nameSpan = document.createElement('div');
      nameSpan.className = 'sender-name';
      nameSpan.textContent = data.senderName;
      var bubble = document.createElement('div');
      bubble.className = 'bubble';
      var timeStr = new Date(data.time).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

      let contentHtml = '';
      if (isImageUrl(data.message)) {
        contentHtml = `<img src="${data.message}" class="chat-image" onclick="window.open(this.src)">`;
      } else {
        contentHtml = `<span>${data.message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>`;
        if (isEmojiOnly(data.message)) bubble.classList.add('only-emoji');
      }

      bubble.innerHTML = `${contentHtml}<div class="msg-time">${timeStr}</div>`;
      
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏•‡∏∞ Animation
      if (data.senderId === myId) {
        row.classList.add('message-right');
      } else {
        row.classList.add('message-left');
      }

      row.appendChild(nameSpan);
      row.appendChild(bubble);
      messagesDiv.appendChild(row);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    let typingTimer;
    function triggerTyping() {
      if(!myId) return;
      database.ref('typing/' + myId).set({ name: myName, timestamp: firebase.database.ServerValue.TIMESTAMP });
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => { database.ref('typing/' + myId).remove(); }, 2000);
    }
    inputField.addEventListener('input', () => { triggerTyping(); });
    if(myId) database.ref('typing/' + myId).onDisconnect().remove();

    database.ref('typing').on('value', function(snapshot) {
      const typers = [];
      snapshot.forEach(child => { if (child.key !== myId) typers.push(child.val().name); });
      if (typers.length > 0) {
        let text = typers.length > 2 ? "‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå" : typers.join(", ") + " ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå";
        typingText.textContent = text;
        typingDiv.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏à‡∏∏‡∏î‡πÑ‡∏Ç‡πà‡∏õ‡∏•‡∏≤
        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } else {
        typingDiv.style.display = 'none';
      }
    });
  </script>
</body>
</html>
