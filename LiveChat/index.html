<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Web Chat</title>
  <style>
    /* --- CSS ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #e5ddd5; }
    
    #messages { 
      list-style-type: none; margin: 0; padding: 20px; padding-bottom: 90px; 
      display: flex; flex-direction: column; height: 100vh; 
      box-sizing: border-box; overflow-y: scroll; 
    }

    .message-row { display: flex; flex-direction: column; margin-bottom: 10px; max-width: 75%; position: relative; }
    .sender-name { font-size: 0.75rem; color: #555; margin-bottom: 2px; margin-left: 8px; }
    .bubble { padding: 10px 14px; border-radius: 18px; font-size: 1rem; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }

    .message-left { align-self: flex-start; }
    .message-left .bubble { background: #ffffff; color: #333; border-bottom-left-radius: 4px; }

    .message-right { align-self: flex-end; align-items: flex-end; }
    .message-right .sender-name { display: none; }
    .message-right .bubble { background: #dcf8c6; color: #333; border-bottom-right-radius: 4px; }

    #form-container { position: fixed; bottom: 0; left: 0; right: 0; background: #f0f0f0; padding: 10px; display: flex; align-items: center; box-shadow: 0 -1px 5px rgba(0,0,0,0.1); z-index: 100; }
    
    #emoji-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; padding: 0 10px; transition: transform 0.2s; }
    #emoji-btn:hover { transform: scale(1.2); }

    input { flex: 1; padding: 12px 15px; border: none; border-radius: 25px; outline: none; font-size: 1rem; }

    #send-btn { margin-left: 10px; background: #128C7E; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    #send-btn:hover { background: #075E54; }

    #emoji-picker { position: fixed; bottom: 75px; left: 10px; background: white; border-radius: 10px; padding: 10px; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; flex-wrap: wrap; gap: 5px; z-index: 1000; max-height: 300px; overflow-y: auto; }
    .emoji-item { font-size: 1.5rem; padding: 5px; cursor: pointer; border-radius: 5px; user-select: none; }
    .emoji-item:hover { background-color: #eee; }
  </style>
</head>
<body>

  <div id="messages"></div>
  <div id="emoji-picker"></div>

  <form id="form-container">
    <button type="button" id="emoji-btn">üòä</button>
    <input id="input" autocomplete="off" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
    <button type="submit" id="send-btn">‚û§</button>
  </form>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // 1. Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCnX049F08ewwCLXOCa3NrKsG499Qce6bI",
      authDomain: "livechat-75751.firebaseapp.com",
      databaseURL: "https://livechat-75751-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "livechat-75751",
      storageBucket: "livechat-75751.firebasestorage.app",
      messagingSenderId: "314131503440",
      appId: "1:314131503440:web:53d6918b7645630bf5f455",
      measurementId: "G-MVP0BBDFQV"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var database = firebase.database();

    // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö
    const badWords = [
      "‡πÄ‡∏´‡∏µ‡πâ‡∏¢", "‡∏™‡∏±‡∏™", "‡πÑ‡∏≠‡πâ‡πÄ‡∏´‡∏µ‡πâ‡∏¢", "‡πÑ‡∏≠‡πâ‡∏™‡∏±‡∏™", "‡∏Ñ‡∏ß‡∏¢", 
      "‡πÄ‡∏¢‡πá‡∏î", "hee", "kuy", "‡∏´‡∏µ", "fuck", 
      "‡πÄ‡∏•‡∏ß", "‡πÇ‡∏á‡πà", "‡∏ö‡πâ‡∏≤" 
    ];

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö
    function censorText(text) {
      let cleanText = text;
      
      badWords.forEach(word => {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Regex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥ (g = ‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ, i = ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà)
        let regex = new RegExp(word, "gi");
        
        // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô (*) ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≥
        let stars = "*".repeat(word.length); 
        
        // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Emoji ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ ‡∏Å‡πá‡πÅ‡∏Å‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô: let stars = "üå∏";
        
        cleanText = cleanText.replace(regex, stars);
      });
      
      return cleanText;
    }

    // 2. ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ ID
    const animals = ["‡∏´‡∏°‡∏π", "‡πÅ‡∏°‡∏ß", "‡πÄ‡∏™‡∏∑‡∏≠", "‡πÑ‡∏Å‡πà", "‡πÄ‡∏õ‡πá‡∏î", "‡∏´‡∏°‡∏µ", "‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢", "‡∏ä‡πâ‡∏≤‡∏á", "‡∏•‡∏¥‡∏á", "‡∏´‡∏°‡∏≤"];
    const adjs = ["‡∏ã‡πà‡∏≤", "‡∏ô‡πâ‡∏≠‡∏¢", "‡πÉ‡∏´‡∏ç‡πà", "‡∏ö‡∏¥‡∏ô‡πÑ‡∏î‡πâ", "‡∏á‡πà‡∏ß‡∏á", "‡∏´‡∏¥‡∏ß", "‡∏à‡∏≠‡∏°‡∏û‡∏•‡∏±‡∏á", "‡∏≠‡∏¥‡∏ô‡∏î‡∏µ‡πâ", "‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å"];

    function getRandomName() {
      const animal = animals[Math.floor(Math.random() * animals.length)];
      const adj = adjs[Math.floor(Math.random() * adjs.length)];
      return animal + adj;
    }

    let myId = localStorage.getItem('chat_id');
    let myName = localStorage.getItem('chat_name');

    if (!myId) {
      myId = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
      myName = getRandomName();
      localStorage.setItem('chat_id', myId);
      localStorage.setItem('chat_name', myName);
    }
    document.getElementById('input').placeholder = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "${myName}" ...`;

    // 3. Emoji
    const emojiList = ["üòÄ","üòÇ","üòç","üòé","üò≠","üò°","üëç","üëé","üôè","‚ù§Ô∏è","üíî","üéâ","üî•","‚ú®","üëÄ","üëª","üê∑","üê∂","üê±","üêî","üåπ","‚òÄÔ∏è","üåô","‚≠ê","‚úÖ","‚ùå","‚ùì","‚ùó","üçî","üç∫","‚öΩ","üéÆ"];
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiBtn = document.getElementById('emoji-btn');
    const inputField = document.getElementById('input');

    emojiList.forEach(emoji => {
      let span = document.createElement('span');
      span.textContent = emoji;
      span.className = 'emoji-item';
      span.addEventListener('click', () => {
        inputField.value += emoji;
        inputField.focus();
      });
      emojiPicker.appendChild(span);
    });

    emojiBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      emojiPicker.style.display = (emojiPicker.style.display === 'flex') ? 'none' : 'flex';
    });
    document.body.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = 'none';
      }
    });

    // 4. ‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    var form = document.getElementById('form-container');
    var messagesDiv = document.getElementById('messages');

    // === ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Gemini (Netlify) ===
    async function askGemini(question) {
      try {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Bubble ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î
        database.ref('chats').push({
          message: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î... ü§ñ",
          senderName: "‡∏ô‡πâ‡∏≠‡∏á Gemini ‚ú®",
          senderId: "gemini_bot",
          time: Date.now()
        });

        // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏´‡∏≤ Netlify Function
        const response = await fetch('/.netlify/functions/gemini', {
          method: 'POST',
          body: JSON.stringify({ message: question })
        });
        
        const data = await response.json();

        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Firebase
        if (data.reply) {
           database.ref('chats').push({
            message: data.reply,
            senderName: "‡∏ô‡πâ‡∏≠‡∏á Gemini ‚ú®",
            senderId: "gemini_bot",
            time: Date.now()
          });
        }
      } catch (error) {
        console.error("Error calling Gemini:", error);
      }
    }

    // === Event Listener ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏£‡∏ß‡∏° Logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ===
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var msg = inputField.value.trim();

      if (msg) {
        // CASE 1: ‡∏•‡∏ö‡∏´‡∏°‡∏î
        if (msg === '/‡∏•‡∏ö‡∏´‡∏°‡∏î') {
            if(confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?")) {
                database.ref('chats').remove();
            }
            inputField.value = '';
            return;
        }

        // CASE 2: ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó (/bot)
        if (msg.startsWith('/bot')) {
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô
            database.ref('chats').push({
                message: msg,
                senderName: myName,
                senderId: myId,
                time: Date.now()
            });
            
            // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ñ‡∏≤‡∏°
            var question = msg.replace('/bot', '').trim();
            if(question) {
                askGemini(question); 
            }
            
            inputField.value = '';
            emojiPicker.style.display = 'none';
            return;
        }

        // CASE 3: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        database.ref('chats').push({
          message: msg,
          senderName: myName,
          senderId: myId,
          time: Date.now()
        });
        
        inputField.value = '';
        emojiPicker.style.display = 'none';
      }
    });

    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    database.ref('chats').on('child_added', function(snapshot) {
      createMessageBubble(snapshot.val());
    });

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏à‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
    database.ref('chats').on('value', function(snapshot) {
      if (!snapshot.exists()) { messagesDiv.innerHTML = ''; }
    });

    function createMessageBubble(data) {
      var row = document.createElement('div');
      var nameSpan = document.createElement('div');
      var bubble = document.createElement('div');

      nameSpan.textContent = data.senderName;
      nameSpan.className = 'sender-name';
      
      bubble.textContent = data.message;
      bubble.className = 'bubble';

      row.className = 'message-row';

      if (data.senderId === myId) {
        row.classList.add('message-right');
      } else if (data.senderId === "gemini_bot") {
        row.classList.add('message-left'); 
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Bubble ‡∏ö‡∏≠‡∏ó ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        bubble.style.backgroundColor = "#fff"; 
        bubble.style.border = "1px solid #ddd";
      } else {
        row.classList.add('message-left');
      }

      row.appendChild(nameSpan);
      row.appendChild(bubble);
      messagesDiv.appendChild(row);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>
