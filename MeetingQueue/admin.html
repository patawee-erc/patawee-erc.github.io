<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #eaeff2; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .date-header { text-align: center; color: #007bff; font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .sub-header { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 25px; }

        .agenda-item { 
            background: #fff; border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 12px; border-radius: 8px; 
            display: flex; align-items: center; transition: all 0.2s; position: relative;
        }
        
        .drag-handle { cursor: grab; padding: 10px 15px 10px 0; color: #b0bec5; font-size: 1.5rem; }
        .info { flex-grow: 1; padding-right: 10px; }
        .info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .info p { margin: 0; color: #666; font-size: 0.9rem; }

        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; color: white; margin-bottom: 5px; font-weight: bold; }

        .controls { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; min-width: 280px; }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; font-size: 0.85rem; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); }

        .btn-tool { background: #e0e0e0; color: #555; padding: 8px; }
        .btn-tool:hover { background: #d6d6d6; }

        /* Status Colors */
        .row-waiting { border-left: 6px solid #bdc3c7; background: #f9f9f9; }
        .badge-waiting { background: #bdc3c7; }
        .row-prepare { border-left: 6px solid #ef5350; background: #ffebee; }
        .badge-prepare { background: #ef5350; }
        .row-current { border-left: 6px solid #29b6f6; background: #e1f5fe; box-shadow: 0 4px 10px rgba(41, 182, 246, 0.2); }
        .badge-current { background: #29b6f6; }
        .btn-current { background: #29b6f6; }
        .row-wrapping_up { border-left: 6px solid #fdd835; background: #fffde7; }
        .badge-wrapping_up { background: #fdd835; color: #333; }
        .btn-wrap { background: #fdd835; color: #333; }
        .row-finished { border-left: 6px solid #66bb6a; background: #e8f5e9; opacity: 0.7; }
        .badge-finished { background: #66bb6a; }
        .btn-finish { background: #66bb6a; }
        
        #loading { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; display: none; z-index: 999; }

        /* ‚ú® NEW: Styles for Add Button & Modal */
        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-add { background: #2ecc71; color: white; padding: 10px 20px; font-size: 1rem; }
        .btn-add:hover { background: #27ae60; }

        /* Modal CSS */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: 'Sarabun'; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save-modal { background: #2ecc71; flex: 1; }
        .btn-cancel-modal { background: #e74c3c; flex: 1; }

    </style>
</head>
<body>

    <div id="loading">üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>

    <div class="container">
        <h1>‚öôÔ∏è Admin - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h1>
        
        <div id="date-display" class="date-header"></div>
        <div class="sub-header">‡∏•‡∏≤‡∏Å ‚ò∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö | ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
        
        <!-- ‚ú® NEW: Top Controls Area -->
        <div class="top-controls">
            <button class="btn btn-add" onclick="openAddModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏£‡∏∞‡πÉ‡∏´‡∏°‡πà</button>
            <button onclick="fetchData()" style="background:none; border:none; color:#29b6f6; cursor:pointer; font-size:0.9rem;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div id="agenda-list">
            <div style="text-align:center; padding: 40px; color:#aaa;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>

    <!-- ‚ú® NEW: Add Agenda Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0; text-align:center; color:#2c3e50;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>
            
            <div class="form-group">
                <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏≤‡∏£‡∏∞:</label>
                <input type="text" id="new-title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...">
            </div>
            
            <div class="form-group">
                <label>‡∏ú‡∏π‡πâ‡∏û‡∏π‡∏î / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠:</label>
                <input type="text" id="new-speaker" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢...">
            </div>

            <div class="modal-actions">
                <button class="btn btn-save-modal" onclick="saveNewAgenda()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-cancel-modal" onclick="closeAddModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL Google Apps Script ‡πÄ‡∏î‡∏¥‡∏°
        const API_URL = "https://script.google.com/macros/s/AKfycbwxEfmj93cut4GJCIXNehjcJaO5XA9zRvpmpmzPH9977ZH6L0Qux1tgcDkU4OgaX9PZJQ/exec"; 

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ ---
        function showThaiDate() {
            const date = new Date();
            const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            const months = [
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];
            
            const dayName = days[date.getDay()];
            const dayNum = date.getDate();
            const monthName = months[date.getMonth()];
            const year = date.getFullYear() + 543;

            document.getElementById('date-display').innerText = `‡∏ß‡∏±‡∏ô ${dayName}‡∏ó‡∏µ‡πà ${dayNum} ${monthName} ${year}`;
        }
        showThaiDate();

        let localData = [];

        function fetchData() {
            document.getElementById('loading').style.display = 'block';
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    localData = data;
                    renderList();
                    document.getElementById('loading').style.display = 'none';
                });
        }
        fetchData();

        function renderList() {
            const list = document.getElementById('agenda-list');
            list.innerHTML = '';
            localData.forEach((item, index) => {
                const statusMap = { 'waiting': '‡∏£‡∏≠', 'prepare': '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß', 'current': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î', 'wrapping_up': '‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏ö', 'finished': '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß' };
                const div = document.createElement('div');
                div.className = `agenda-item row-${item.status}`;
                div.innerHTML = `
                    <div class="drag-handle">‚ò∞</div>
                    <div class="info">
                        <span class="status-badge badge-${item.status}">${statusMap[item.status]}</span>
                        <h3>${item.title}</h3>
                        <p>üë§ ${item.speaker}</p>
                    </div>
                    <div class="controls">
                        <button class="btn btn-tool" onclick="editInfo(${index})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                        <button class="btn btn-tool" onclick="changeStatus(${index}, 'waiting')" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï">‚Ü∫</button>
                        ${renderButtons(index, item.status)}
                    </div>
                `;
                list.appendChild(div);
            });
            initSortable();
        }

        function renderButtons(index, status) {
            if (status === 'finished') return '';
            return `
                <button class="btn btn-current" onclick="changeStatus(${index}, 'current')">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
                <button class="btn btn-wrap" onclick="changeStatus(${index}, 'wrapping_up')">‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏ö</button>
                <button class="btn btn-finish" onclick="changeStatus(${index}, 'finished')">‡∏à‡∏ö</button>
            `;
        }

        // --- ‚ú® NEW: Modal & Add Logic ---
        function openAddModal() {
            document.getElementById('new-title').value = '';
            document.getElementById('new-speaker').value = '';
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('new-title').focus();
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function saveNewAgenda() {
            const title = document.getElementById('new-title').value.trim();
            const speaker = document.getElementById('new-speaker').value.trim();

            if (!title) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏≤‡∏£‡∏∞");
                return;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ Array
            const newItem = {
                title: title,
                speaker: speaker || "-", // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡∏Ç‡∏µ‡∏î‡πÑ‡∏ß‡πâ
                status: "waiting"
            };
            
            localData.push(newItem);
            
            closeAddModal();
            renderList(); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            saveAllData(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Server
        }
        
        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
        window.onclick = function(event) {
            const modal = document.getElementById('addModal');
            if (event.target == modal) {
                closeAddModal();
            }
        }
        // ------------------------------------

        function editInfo(index) {
            let item = localData[index];
            let newTitle = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏≤‡∏£‡∏∞:", item.title);
            if (newTitle !== null) {
                let newSpeaker = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏π‡∏î:", item.speaker);
                if (newSpeaker !== null) {
                    localData[index].title = newTitle;
                    localData[index].speaker = newSpeaker;
                    renderList();
                    saveAllData();
                }
            }
        }

        function changeStatus(index, newStatus) {
            localData[index].status = newStatus;
            
            // Auto Logic
            if (index + 1 < localData.length) {
                let nextItem = localData[index + 1];
                if (newStatus === 'wrapping_up' && nextItem.status === 'waiting') {
                    nextItem.status = 'prepare';
                }
                if (newStatus === 'finished') {
                    if (nextItem.status === 'waiting' || nextItem.status === 'prepare') {
                        nextItem.status = 'current';
                    }
                }
            }
            renderList();
            saveAllData();
        }

        function saveAllData() {
            const loader = document.getElementById('loading');
            loader.style.display = 'block';
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'saveAll', data: localData })
            }).then(() => { setTimeout(() => { loader.style.display = 'none'; }, 500); });
        }

        function initSortable() {
            const el = document.getElementById('agenda-list');
            Sortable.create(el, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function (evt) {
                    const item = localData.splice(evt.oldIndex, 1)[0];
                    localData.splice(evt.newIndex, 0, item);
                    saveAllData();
                }
            });
        }
    </script>
</body>
</html>
