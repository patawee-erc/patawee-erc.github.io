<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML to PPTX - Pixel Perfect Editor</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { background-color: #f1f5f9; font-family: 'Prompt', sans-serif; height: 100vh; overflow: hidden; }
        
        .main-layout { display: grid; grid-template-columns: 240px 400px 1fr; height: 100vh; }
        
        /* 1. Slide List Panel */
        .slide-panel { background: #e2e8f0; border-right: 1px solid #cbd5e1; padding: 10px; display: flex; flex-direction: column; overflow-y: auto; }
        .slide-item { 
            position: relative; background: white; margin-bottom: 12px; border-radius: 8px; 
            height: 120px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .slide-item.active { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .slide-thumb-num { position: absolute; bottom: 6px; right: 6px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; z-index: 10; font-weight: bold;}
        .btn-del { position: absolute; top: 6px; right: 6px; background: #ef4444; color: white; width: 22px; height: 22px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 14px; z-index: 20; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .slide-item:hover .btn-del { display: flex; }

        /* 2. Editor Panel */
        .editor-panel { background: white; border-right: 1px solid #cbd5e1; display: flex; flex-direction: column; z-index: 10; box-shadow: 4px 0 15px rgba(0,0,0,0.05); }
        .editor-header { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .editor-footer { padding: 12px 16px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; flex-direction: column; gap: 8px; }
        
        /* 3. Preview Panel */
        .preview-panel { background: #475569; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #preview-wrapper { 
            width: 1920px; height: 1080px; 
            background: white; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.5); 
            transform-origin: top left;
        }
        #preview-frame { width: 100%; height: 100%; border: none; display: block; }
        
        /* Loading Overlay */
        .loader { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 50; backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <div class="main-layout">
        <!-- LEFT: Slide Manager -->
        <div class="slide-panel">
            <div class="flex justify-between items-center mb-4 px-1">
                <h2 class="font-bold text-slate-700 text-sm tracking-wide">SLIDES MANAGER</h2>
                <button onclick="addSlide()" class="bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 flex items-center justify-center rounded-full shadow transition hover:scale-105">
                    <i class="ph ph-plus-bold"></i>
                </button>
            </div>
            <div id="slide-list" class="flex-1"></div>
        </div>

        <!-- MIDDLE: Code Editor -->
        <div class="editor-panel">
            <div class="editor-header">
                <h1 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="ph ph-code-block text-blue-600 text-lg"></i> Code Editor
                </h1>
                <p class="text-xs text-slate-500 mt-1">
                    Edit HTML below or <b class="text-blue-600">Click on text</b> in preview.
                </p>
            </div>
            
            <textarea id="htmlInput" class="flex-1 w-full p-4 font-mono text-xs outline-none resize-none text-slate-700 bg-white leading-relaxed" spellcheck="false" placeholder="<!-- Paste your HTML here -->"></textarea>

            <div class="editor-footer">
                <div class="flex gap-2">
                    <button onclick="updatePreviewFromCode(true)" class="flex-1 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-xs font-bold rounded transition">
                        Force Refresh
                    </button>
                    <button onclick="copyToClipboard()" class="w-10 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded flex items-center justify-center" title="Copy Code">
                        <i class="ph ph-copy"></i>
                    </button>
                </div>
                <button onclick="exportPPTX()" class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white text-sm font-bold rounded shadow-md hover:shadow-lg transition flex justify-center items-center gap-2">
                    <i class="ph ph-download-simple text-xl"></i> Export Presentation
                </button>
            </div>
        </div>

        <!-- RIGHT: Preview -->
        <div class="preview-panel" id="previewPanel">
            <!-- Scale Wrapper -->
            <div id="scale-container">
                <div id="preview-wrapper">
                    <iframe id="preview-frame"></iframe>
                </div>
            </div>

            <!-- Loader -->
            <div id="loader" class="loader hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
                <span class="font-bold text-lg">Rendering High-Res Slide...</span>
                <span class="text-sm text-slate-400 mt-1">Please wait a moment</span>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const WIDTH = 1920;
        const HEIGHT = 1080;

        // --- State ---
        let slides = [];
        let currentIndex = 0;
        let isEditingIframe = false; // Flag to prevent refresh loop
        let isThrottled = false;

        // --- DOM ---
        const htmlInput = document.getElementById('htmlInput');
        const previewFrame = document.getElementById('preview-frame');
        const slideList = document.getElementById('slide-list');
        const loader = document.getElementById('loader');
        const previewPanel = document.getElementById('previewPanel');
        const scaleContainer = document.getElementById('scale-container');
        const previewWrapper = document.getElementById('preview-wrapper');

        // --- Templates ---
        // 1. Font Loading
        const fontLinks = `<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;700&family=Kanit:wght@300;400;700&family=Mitr:wght@300;400&family=Prompt:wght@300;400;700&family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">`;
        
        // 2. CSS Reset & Base Styles (หัวใจสำคัญของการแก้ปัญหาแสดงผลไม่ตรง)
        const baseStyles = `
            <style>
                /* CSS Reset */
                *, *::before, *::after { box-sizing: border-box; }
                html, body { margin: 0; padding: 0; width: ${WIDTH}px; height: ${HEIGHT}px; overflow: hidden; }
                body { background-color: white; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
                
                /* Visual Cues for Editing (Only visible on hover/focus) */
                .hover-edit:hover { outline: 2px dashed #3b82f6; cursor: text; border-radius: 2px; }
                .active-edit { outline: 2px solid #2563eb; position: relative; z-index: 50; }
                
                /* Hide Scrollbars */
                ::-webkit-scrollbar { display: none; }
            </style>
        `;

        // 3. Default Content
        const defaultSlide = `
<div class="w-full h-full relative font-['Sarabun'] bg-slate-900 text-white flex flex-col items-center justify-center overflow-hidden">
    <!-- Background -->
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black z-0"></div>
    <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-blue-500/20 rounded-full blur-[100px] translate-x-1/3 -translate-y-1/3"></div>

    <!-- Content -->
    <div class="relative z-10 text-center max-w-5xl">
        <div class="inline-block px-4 py-1 rounded-full border border-blue-500/30 bg-blue-500/10 text-blue-300 text-sm font-bold tracking-wider mb-8">
            PIXEL PERFECT ENGINE
        </div>
        <h1 class="text-8xl font-black mb-6 leading-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-200 via-white to-blue-200">
            หน้าจอตรงกับ Code 100%
        </h1>
        <p class="text-2xl text-slate-400 font-light leading-relaxed px-20">
            ระบบนี้ใช้ CSS Reset และ Box-Sizing: Border-Box ทำให้การจัดวาง Layout แม่นยำ
            <br>ลองคลิกที่ข้อความนี้เพื่อแก้ไขได้ทันที (Realtime)
        </p>
    </div>

    <!-- Bottom Bar -->
    <div class="absolute bottom-0 w-full h-24 border-t border-white/5 bg-white/5 backdrop-blur-sm flex items-center justify-between px-16">
        <span class="text-slate-500 font-mono text-lg">SLIDE 01</span>
        <div class="flex gap-4">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
        </div>
    </div>
</div>`;

        // --- Initialization ---
        function init() {
            slides.push(defaultSlide);
            renderSlideList();
            loadSlide(0);
            resizePreview();
            window.addEventListener('resize', resizePreview);
        }

        // --- Logic: Slide Management ---
        function addSlide() {
            slides.push(defaultSlide);
            renderSlideList();
            loadSlide(slides.length - 1);
        }

        function deleteSlide(idx, e) {
            e.stopPropagation();
            if(slides.length <= 1) return alert("Keep at least one slide.");
            if(confirm("Delete this slide?")) {
                slides.splice(idx, 1);
                if(currentIndex >= slides.length) currentIndex = slides.length - 1;
                renderSlideList();
                loadSlide(currentIndex);
            }
        }

        function renderSlideList() {
            slideList.innerHTML = '';
            slides.forEach((slide, idx) => {
                const el = document.createElement('div');
                el.className = `slide-item ${idx === currentIndex ? 'active' : ''}`;
                el.onclick = () => loadSlide(idx);
                // Create a generic thumbnail
                el.innerHTML = `
                    <div class="slide-thumb-num">${idx + 1}</div>
                    <div class="btn-del" onclick="deleteSlide(${idx}, event)">×</div>
                    <div class="w-full h-full flex flex-col items-center justify-center bg-gray-50 text-gray-300 select-none pointer-events-none">
                        <i class="ph ph-image text-3xl mb-1"></i>
                        <span class="text-[10px] font-bold">SLIDE ${idx + 1}</span>
                    </div>
                `;
                slideList.appendChild(el);
            });
        }

        function loadSlide(idx) {
            isEditingIframe = false; // Reset lock
            currentIndex = idx;
            htmlInput.value = slides[idx];
            updatePreviewFromCode(true); // Force update
            
            // Update active class
            document.querySelectorAll('.slide-item').forEach((el, i) => {
                if(i === idx) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        // --- Logic: Preview & Edit Sync ---

        function updatePreviewFromCode(force = false) {
            if (isEditingIframe && !force) return;

            const content = htmlInput.value;
            const doc = previewFrame.contentWindow.document;

            // Construct Full HTML with Reset
            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    ${fontLinks}
                    ${baseStyles}
                </head>
                <body>${content}</body>
                </html>
            `;
            
            doc.open();
            doc.write(fullHtml);
            doc.close();

            // Re-attach listeners after load
            previewFrame.onload = () => {
                enableVisualEditing(doc);
            };
        }

        function enableVisualEditing(doc) {
            const body = doc.body;

            // 1. Identify Text Elements
            const elements = body.querySelectorAll('*');
            elements.forEach(el => {
                // Check if element has direct text content (not just children)
                const hasText = Array.from(el.childNodes).some(node => node.nodeType === 3 && node.textContent.trim().length > 0);
                
                // Allow editing on headings, paragraphs, spans, divs with text
                if (hasText && !el.closest('script') && !el.closest('style')) {
                    el.classList.add('hover-edit');
                    
                    el.onclick = (e) => {
                        e.stopPropagation();
                        // Reset previous
                        doc.querySelectorAll('[contenteditable]').forEach(x => {
                            x.contentEditable = "false";
                            x.classList.remove('active-edit');
                        });
                        // Activate current
                        el.contentEditable = "true";
                        el.classList.add('active-edit');
                        el.focus();
                        isEditingIframe = true; // Lock refresh
                    };
                }
            });

            // 2. Capture Changes
            const observer = new MutationObserver(() => {
                // Throttle updates slightly
                if (isThrottled) return;
                isThrottled = true;
                setTimeout(() => { isThrottled = false; }, 200);

                // Clone to clean
                const cloneBody = body.cloneNode(true);
                cloneBody.querySelectorAll('*').forEach(el => {
                    el.removeAttribute('contenteditable');
                    el.classList.remove('hover-edit');
                    el.classList.remove('active-edit');
                    if(el.getAttribute('class') === '') el.removeAttribute('class');
                });

                const cleanHTML = cloneBody.innerHTML;
                htmlInput.value = cleanHTML;
                slides[currentIndex] = cleanHTML;
            });

            observer.observe(body, { characterData: true, subtree: true, childList: true });

            // 3. Unlock on click away
            doc.addEventListener('click', (e) => {
                if(e.target === doc.body || e.target.tagName === 'HTML') {
                    isEditingIframe = false;
                    doc.querySelectorAll('[contenteditable]').forEach(el => {
                        el.contentEditable = "false";
                        el.classList.remove('active-edit');
                    });
                }
            });
        }

        // Textarea Input Listener
        let inputTimer;
        htmlInput.addEventListener('keyup', () => {
            isEditingIframe = false; // Force unlock
            slides[currentIndex] = htmlInput.value;
            clearTimeout(inputTimer);
            inputTimer = setTimeout(() => updatePreviewFromCode(false), 500);
        });

        // --- Logic: Scaling ---
        function resizePreview() {
            // Calculate scale based on container size vs 1920x1080
            const containerW = previewPanel.clientWidth - 40; // padding
            const containerH = previewPanel.clientHeight - 40;
            
            const scale = Math.min(containerW / WIDTH, containerH / HEIGHT);
            
            // Apply scale to wrapper, not iframe directly (better for some browsers)
            scaleContainer.style.width = `${WIDTH}px`;
            scaleContainer.style.height = `${HEIGHT}px`;
            scaleContainer.style.transform = `scale(${scale})`;
            
            // Center it
            // Note: Since we use flex center on parent, this transform works well
        }

        // --- Logic: Export ---
        async function exportPPTX() {
            loader.classList.remove('hidden');
            let pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';

            const savedIndex = currentIndex;

            try {
                for (let i = 0; i < slides.length; i++) {
                    const doc = previewFrame.contentWindow.document;
                    doc.open();
                    // Export specific Template (Clean, no editing classes)
                    doc.write(`
                        <html>
                        <head>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            ${fontLinks}
                            <style>
                                *, *::before, *::after { box-sizing: border-box; }
                                body { margin: 0; padding: 0; width: 1920px; height: 1080px; overflow: hidden; background: white; }
                            </style>
                        </head>
                        <body>${slides[i]}</body>
                        </html>
                    `);
                    doc.close();

                    // Wait for rendering & fonts
                    await new Promise(r => setTimeout(r, 1000));
                    await document.fonts.ready;
                    
                    // Wait for images
                    const imgs = doc.images;
                    for(let img of imgs) {
                        if(!img.complete) await new Promise(r => img.onload = r);
                    }

                    // Snapshot
                    const dataUrl = await htmlToImage.toPng(doc.body, {
                        quality: 1.0, width: 1920, height: 1080, pixelRatio: 1.5
                    });

                    let slide = pptx.addSlide();
                    slide.addImage({ data: dataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                }
                
                await pptx.writeFile({ fileName: 'Presentation.pptx' });
            } catch (err) {
                console.error(err);
                alert("Export Failed: " + err.message);
            } finally {
                loader.classList.add('hidden');
                loadSlide(savedIndex); // Restore
            }
        }
        
        function copyToClipboard() {
            htmlInput.select();
            document.execCommand('copy');
            alert("Code copied to clipboard!");
        }

        // Run
        init();

    </script>
</body>
</html>
